# /config/packages/30_zaehler_haus.yaml
# Haus-Zähler (jahresneutral): Utility-Meter + optionale manuelle Fallbacks

utility_meter:
  haus_strom_kwh_year:
    name: "Haus – Strom: Jahr"
    source: sensor.zaehler_haus_allgemein_haus_zahlerstand_kanal_1_gesamt_kwh
    cycle: yearly

  haus_wasser_m3_year:
    name: "Haus – Wasser: Jahr"
    source: sensor.water_total_m3        # TODO: Quelle bestätigen
    cycle: yearly

  haus_heizung_kwh_year:
    name: "Haus – Heizung/WW: Jahr"
    source: sensor.zaehler_xiao_c6_wp_zahlerstand_gesamt_kwh
    cycle: yearly

input_number:
  haus_strom_kwh_manual:
    name: "Haus – Strom: Jahr (manuell) [kWh]"
    min: 0
    max: 1000000
    step: 1
    mode: box
    unit_of_measurement: "kWh"

  haus_wasser_m3_manual:
    name: "Haus – Wasser: Jahr (manuell) [m³]"
    min: 0
    max: 100000
    step: 0.001
    mode: box
    unit_of_measurement: "m³"

  haus_heizung_kwh_manual:
    name: "Haus – Heizung/WW: Jahr (manuell) [kWh]"
    min: 0
    max: 1000000
    step: 1
    mode: box
    unit_of_measurement: "kWh"

template:
  - sensor:
      # Jahreswerte mit Fallback (IDs jahresneutral)
      - name: haus_strom_kwh_jahr
        unique_id: haus_strom_kwh_jahr
        device_class: energy
        state_class: total
        unit_of_measurement: "kWh"
        availability: >
          {{ states('sensor.haus_strom_kwh_year') not in ['unknown','unavailable',''] 
             or states('input_number.haus_strom_kwh_manual') not in ['unknown','unavailable',''] }}
        state: >
          {% set m = states('sensor.haus_strom_kwh_year') %}
          {{ (m if m not in ['unknown','unavailable',''] 
                else states('input_number.haus_strom_kwh_manual')) | float(0) }}

      - name: haus_wasser_m3_jahr
        unique_id: haus_wasser_m3_jahr
        device_class: water
        state_class: total
        unit_of_measurement: "m³"
        availability: >
          {{ states('sensor.haus_wasser_m3_year') not in ['unknown','unavailable',''] 
             or states('input_number.haus_wasser_m3_manual') not in ['unknown','unavailable',''] }}
        state: >
          {% set m = states('sensor.haus_wasser_m3_year') %}
          {{ (m if m not in ['unknown','unavailable',''] 
                else states('input_number.haus_wasser_m3_manual')) | float(0) }}

      - name: haus_heizung_kwh_jahr         # <— vereinheitlicht (vorher: heizenergie)
        unique_id: haus_heizung_kwh_jahr
        device_class: energy
        state_class: total
        unit_of_measurement: "kWh"
        availability: >
          {{ states('sensor.haus_heizung_kwh_year') not in ['unknown','unavailable',''] 
             or states('input_number.haus_heizung_kwh_manual') not in ['unknown','unavailable',''] }}
        state: >
          {% set m = states('sensor.haus_heizung_kwh_year') %}
          {{ (m if m not in ['unknown','unavailable',''] 
                else states('input_number.haus_heizung_kwh_manual')) | float(0) }}
