# /config/packages/31_zaehler_whg01.yaml
# Zähler & Eichfristen – WHG01 (+ MQTT-Felder WaterStar M)

# ───────────────────────────────────────────────────────────────────────────────
# Stammdaten
# ───────────────────────────────────────────────────────────────────────────────
input_text:
  whg01_wasser_kalt_meter_id:
    name: "WHG01 – Wasser kalt: Meter-ID"
    max: 32
  whg01_wasser_kalt_meter_key:
    name: "WHG01 – Wasser kalt: Meter-Key"          # <— ohne „HEX“
    max: 64
  whg01_wasser_kalt_hersteller:
    name: "WHG01 – Wasser kalt: Hersteller/Typ"
    max: 80
  whg01_wasser_kalt_standort:
    name: "WHG01 – Wasser kalt: Standort"
    max: 80

  whg01_wasser_warm_meter_id:
    name: "WHG01 – Wasser warm: Meter-ID"
    max: 32
  whg01_wasser_warm_meter_key:
    name: "WHG01 – Wasser warm: Meter-Key"          # <— ohne „HEX“
    max: 64
  whg01_wasser_warm_hersteller:
    name: "WHG01 – Wasser warm: Hersteller/Typ"
    max: 80
  whg01_wasser_warm_standort:
    name: "WHG01 – Wasser warm: Standort"
    max: 80

  whg01_wmz_meter_id:
    name: "WHG01 – WMZ: Meter-ID"
    max: 32
  whg01_wmz_meter_key:
    name: "WHG01 – WMZ: Meter-Key"                  # <— ohne „HEX“
    max: 64
  whg01_wmz_hersteller:
    name: "WHG01 – WMZ: Hersteller/Typ"
    max: 80
  whg01_wmz_standort:
    name: "WHG01 – WMZ: Standort"
    max: 80

  whg01_strom_meter_id:
    name: "WHG01 – Strom: Zählernummer/ID"
    max: 32
  whg01_strom_meter_key:
    name: "WHG01 – Strom: Schlüssel (optional)"     # konsistent ohne HEX
    max: 64
  whg01_strom_hersteller:
    name: "WHG01 – Strom: Hersteller/Typ"
    max: 80
  whg01_strom_standort:
    name: "WHG01 – Strom: Standort"
    max: 80

input_number:
  whg01_kw_eichfrist_jahre:
    name: "WHG01 – Wasser kalt: Eichfrist [Jahre]"
    min: 1
    max: 20
    step: 1
    mode: box
    initial: 6
  whg01_ww_eichfrist_jahre:
    name: "WHG01 – Wasser warm: Eichfrist [Jahre]"
    min: 1
    max: 20
    step: 1
    mode: box
    initial: 6
  whg01_wmz_eichfrist_jahre:
    name: "WHG01 – WMZ: Eichfrist [Jahre]"
    min: 1
    max: 20
    step: 1
    mode: box
    initial: 6
  whg01_strom_eichfrist_jahre:
    name: "WHG01 – Strom: Eichfrist [Jahre]"
    min: 1
    max: 20
    step: 1
    mode: box
    initial: 8

input_datetime:
  whg01_wasser_kalt_montage:
    name: "WHG01 – Wasser kalt: Montage"
    has_date: true
    has_time: false
  whg01_wasser_warm_montage:
    name: "WHG01 – Wasser warm: Montage"
    has_date: true
    has_time: false
  whg01_wmz_montage:
    name: "WHG01 – WMZ: Montage"
    has_date: true
    has_time: false
  whg01_strom_montage:
    name: "WHG01 – Strom: Montage"
    has_date: true
    has_time: false

# ───────────────────────────────────────────────────────────────────────────────
# Ablauf der Eichfristen (Timestamp inkl. lokaler Zeit)
# ───────────────────────────────────────────────────────────────────────────────
template:
  - sensor:
      - name: whg01_kw_eich_ablauf
        unique_id: whg01_kw_eich_ablauf
        device_class: timestamp
        state: >-
          {% set d = states('input_datetime.whg01_wasser_kalt_montage') %}
          {% set y = states('input_number.whg01_kw_eichfrist_jahre')|int(0) %}
          {% if d not in ['unknown','unavailable',''] and y > 0 %}
            {% set base = as_datetime(d) %}
            {{ as_local(base.replace(year=base.year + y)).isoformat() }}
          {% else %} {{ none }} {% endif %}

      - name: whg01_ww_eich_ablauf
        unique_id: whg01_ww_eich_ablauf
        device_class: timestamp
        state: >-
          {% set d = states('input_datetime.whg01_wasser_warm_montage') %}
          {% set y = states('input_number.whg01_ww_eichfrist_jahre')|int(0) %}
          {% if d not in ['unknown','unavailable',''] and y > 0 %}
            {% set base = as_datetime(d) %}
            {{ as_local(base.replace(year=base.year + y)).isoformat() }}
          {% else %} {{ none }} {% endif %}

      - name: whg01_wmz_eich_ablauf
        unique_id: whg01_wmz_eich_ablauf
        device_class: timestamp
        state: >-
          {% set d = states('input_datetime.whg01_wmz_montage') %}
          {% set y = states('input_number.whg01_wmz_eichfrist_jahre')|int(0) %}
          {% if d not in ['unknown','unavailable',''] and y > 0 %}
            {% set base = as_datetime(d) %}
            {{ as_local(base.replace(year=base.year + y)).isoformat() }}
          {% else %} {{ none }} {% endif %}

      - name: whg01_strom_eich_ablauf
        unique_id: whg01_strom_eich_ablauf
        device_class: timestamp
        state: >-
          {% set d = states('input_datetime.whg01_strom_montage') %}
          {% set y = states('input_number.whg01_strom_eichfrist_jahre')|int(0) %}
          {% if d not in ['unknown','unavailable',''] and y > 0 %}
            {% set base = as_datetime(d) %}
            {{ as_local(base.replace(year=base.year + y)).isoformat() }}
          {% else %} {{ none }} {% endif %}

# ───────────────────────────────────────────────────────────────────────────────
# MQTT → WaterStar M (wmbusmeters)
# ───────────────────────────────────────────────────────────────────────────────
mqtt:
  sensor:
    - name: "whg01_wasser_total_m3"
      unique_id: whg01_wasser_total_m3
      state_topic: "wmbusmeters/Wasserzaehler_Whg01"
      value_template: "{{ value_json.total_m3 | float(0) }}"
      unit_of_measurement: "m³"
      device_class: water
      state_class: total_increasing
      json_attributes_topic: "wmbusmeters/Wasserzaehler_Whg01"

# ───────────────────────────────────────────────────────────────────────────────
# Abgeleitete Anzeige-Felder (aus den MQTT-Attributen)
# ───────────────────────────────────────────────────────────────────────────────
template:
  - sensor:
      # Zählernummer (aus JSON id)
      - name: "whg01_wasser_zaehlernummer"
        unique_id: whg01_wasser_zaehlernummer
        state: "{{ state_attr('sensor.whg01_wasser_total_m3','id') or 'unknown' }}"

      # Hersteller/Modell (fest für WaterStar M)
      - name: "whg01_wasser_hersteller"
        unique_id: whg01_wasser_hersteller
        state: "Engelmann"
      - name: "whg01_wasser_modell"
        unique_id: whg01_wasser_modell
        state: "WaterStar M"

      # Funkmodus (aus Add-on-Konfig → C1)
      - name: "whg01_wasser_funkmodus"
        unique_id: whg01_wasser_funkmodus
        state: "C1"

      # Empfangspegel
      - name: "whg01_wasser_rssi_dbm"
        unique_id: whg01_wasser_rssi_dbm
        unit_of_measurement: "dBm"
        state: "{{ state_attr('sensor.whg01_wasser_total_m3','rssi_dbm') | default('unknown') }}"

      # Letztes empfangenes Telegramm (UTC ISO)
      - name: "whg01_wasser_telegramm_zeit"
        unique_id: whg01_wasser_telegramm_zeit
        device_class: timestamp
        state: >
          {% set ts = state_attr('sensor.whg01_wasser_total_m3','timestamp') %}
          {{ ts if ts not in ['unknown','unavailable',None] else now().isoformat() }}

      # Gerätezeit im Zähler (falls gesetzt)
      - name: "whg01_wasser_meter_datetime"
        unique_id: whg01_wasser_meter_datetime
        device_class: timestamp
        state: >
          {% set dt = state_attr('sensor.whg01_wasser_total_m3','meter_datetime') %}
          {{ (dt ~ ':00') if dt not in ['unknown','unavailable',None] else now().isoformat() }}

      # Spiegel des Totalstands (für Karten, die nur Templates nehmen)
      - name: "whg01_wasser_total_m3_spiegel"
        unique_id: whg01_wasser_total_m3_spiegel
        unit_of_measurement: "m³"
        device_class: water
        state_class: total_increasing
        state: "{{ states('sensor.whg01_wasser_total_m3') | float(0) }}"
