# /config/packages/export_betriebskosten.yaml
# Zweck: REST-Export der Betriebskosten-PDF über den externen Flask-Dienst
#        + Benachrichtigung mit klickbarem Link auf die neueste PDF.
# Annahmen: input_number.abrechnung_jahr ist vorhanden und enthält das Zieljahr.
# Ergebnis: Button-Entity und Script, das den Export anstößt und den Link anzeigt.

rest_command:
  export_betriebskosten_pdf:
    url: "http://192.168.178.5:5000/export?jahr={{ states('input_number.abrechnung_jahr') | int }}"
    method: GET
    timeout: 60

script:
  export_betriebskosten_pdf_now:
    alias: "Export Betriebskosten PDF jetzt"
    mode: single
    sequence:
      - variables:
          jahr: "{{ states('input_number.abrechnung_jahr') | int }}"
      - service: rest_command.export_betriebskosten_pdf
      - delay: "00:00:02"   # kleine Wartezeit, bis die Datei geschrieben ist
      - service: persistent_notification.create
        data:
          title: "Betriebskosten-Export {{ jahr }}"
          message: >
            Fertig. Öffnen: http://192.168.178.60:8123/local/exports/bk_{{ jahr }}_latest.pdf

template:
  - button:
      - name: "Export Betriebskosten PDF"
        unique_id: export_betriebskosten_pdf_button
        icon: mdi:file-pdf-box
        press:
          - service: script.export_betriebskosten_pdf_now

