# /config/packages/99_bk_export.yaml
# Betriebskosten-Export – lokal (HA liefert /local/... aus)
# Server erwartet GET → wir senden beide Key-Varianten (mit & ohne whg01_).

rest_command:
  export_betriebskosten_pdf:
    method: GET
    url: >-
      {% set y   = (states('input_number.abrechnungsjahr')|int(0)) or now().year %}
      {% set sel = states('input_select.haus_verteilerschluessel') or 'flaeche' %}
      {% set share = (state_attr('sensor.whg01_share','share_factor')|float(0)) %}
      {% set k_m3  = states('sensor.whg01_wasser_kalt_m3_gesamt')|float(0) %}
      {% set w_m3  = states('sensor.whg01_wasser_warm_m3_gesamt')|float(0) %}
      {% set kwh   = states('sensor.whg01_strom_kwh_gesamt_auto')|float(0) %}
      {% set p_w   = states('sensor.haus_kosten_wasser_eur_m3_eff')|float(0) %}
      {% set p_a   = states('sensor.haus_kosten_abwasser_eur_m3_eff')|float(0) %}
      {% set p_st  = states('sensor.haus_kosten_strom_eur_kwh_eff')|float(0) %}
      {% set b_w   = states('sensor.whg01_wasser_anteil_eur')|float(0) %}
      {% set b_a   = states('sensor.whg01_abwasser_anteil_eur')|float(0) %}
      {% set b_sv  = states('sensor.whg01_strom_variabel_anteil_eur')|float(0) %}
      {% set b_sg  = states('sensor.whg01_strom_grundpreis_anteil_eur')|float(0) %}
      {% set b_g   = states('sensor.whg01_grundsteuer_anteil_eur')|float(0) %}
      {% set b_v   = states('sensor.whg01_versicherung_anteil_eur')|float(0) %}
      {% set b_m   = states('sensor.whg01_muell_anteil_eur')|float(0) %}
      {% set b_n   = states('sensor.whg01_niederschlagswasser_anteil_eur')|float(0) %}
      {% set b_wh  = states('sensor.whg01_wartung_heizung_anteil_eur')|float(0) %}
      {% set b_as  = states('sensor.whg01_abrechnungsservice_anteil_eur')|float(0) %}
      {% set b_sum = states('sensor.whg01_betriebskosten_summe_eur')|float(0) %}
      {% set qp = [
          'wohnung=WHG01',
          'whg=whg01',
          'abrechnungsjahr=' ~ y,
          'jahr=' ~ y,
          'created_at=' ~ (now().isoformat() | urlencode),
          'verteilerschluessel=' ~ (sel | urlencode),
          'share=' ~ ('%.6f' % share),
          'wasser_kalt_m3_gesamt=' ~ ('%.3f' % k_m3),
          'wasser_warm_m3_gesamt=' ~ ('%.3f' % w_m3),
          'strom_kwh_gesamt=' ~ ('%.3f' % kwh),
          'kosten_wasser_eur_m3=' ~ ('%.4f' % p_w),
          'kosten_abwasser_eur_m3=' ~ ('%.4f' % p_a),
          'kosten_strom_eur_kwh=' ~ ('%.4f' % p_st),
          'wasser_anteil_eur=' ~ ('%.2f' % b_w),
          'abwasser_anteil_eur=' ~ ('%.2f' % b_a),
          'strom_variabel_anteil_eur=' ~ ('%.2f' % b_sv),
          'strom_grundpreis_anteil_eur=' ~ ('%.2f' % b_sg),
          'grundsteuer_anteil_eur=' ~ ('%.2f' % b_g),
          'versicherung_anteil_eur=' ~ ('%.2f' % b_v),
          'muell_anteil_eur=' ~ ('%.2f' % b_m),
          'niederschlagswasser_anteil_eur=' ~ ('%.2f' % b_n),
          'wartung_heizung_anteil_eur=' ~ ('%.2f' % b_wh),
          'abrechnungsservice_anteil_eur=' ~ ('%.2f' % b_as),
          'betriebskosten_summe_eur=' ~ ('%.2f' % b_sum),
          'whg01_wasser_anteil_eur=' ~ ('%.2f' % b_w),
          'whg01_abwasser_anteil_eur=' ~ ('%.2f' % b_a),
          'whg01_strom_variabel_anteil_eur=' ~ ('%.2f' % b_sv),
          'whg01_strom_grundpreis_anteil_eur=' ~ ('%.2f' % b_sg),
          'whg01_grundsteuer_anteil_eur=' ~ ('%.2f' % b_g),
          'whg01_versicherung_anteil_eur=' ~ ('%.2f' % b_v),
          'whg01_muell_anteil_eur=' ~ ('%.2f' % b_m),
          'whg01_niederschlagswasser_anteil_eur=' ~ ('%.2f' % b_n),
          'whg01_wartung_heizung_anteil_eur=' ~ ('%.2f' % b_wh),
          'whg01_abrechnungsservice_anteil_eur=' ~ ('%.2f' % b_as),
          'whg01_betriebskosten_summe_eur=' ~ ('%.2f' % b_sum),
          'debug=1',
          'v=' ~ (now().timestamp() | int | string)
      ] %}
      http://192.168.178.5:5000/export?{{ qp | join('&') }}

script:
  export_betriebskosten_pdf_now:
    alias: "Export: Betriebskosten PDF jetzt"
    mode: single
    sequence:
      - variables:
          y: "{{ (states('input_number.abrechnungsjahr')|int(0)) or now().year }}"
          t: "{{ now().timestamp() | int }}"
          base_url: "http://192.168.178.60:8123"
      - service: rest_command.export_betriebskosten_pdf
      - service: persistent_notification.create
        data:
          title: "Betriebskosten-Export {{ y }}"
          message: >-
            Fertig. Öffnen: {{ base_url }}/local/exports/bk_{{ y }}_latest.pdf?v={{ t }}
          notification_id: "bk_pdf_export"

template:
  - button:
      - name: "Export Betriebskosten PDF"
        unique_id: export_betriebskosten_pdf_button
        icon: mdi:file-pdf-box
        press:
          - service: script.export_betriebskosten_pdf_now
