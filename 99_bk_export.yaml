# Betriebskosten-Export WHG01 – jahresneutral über input_number.abrechnungsjahr
# Fix: Direktlink mit Cache-Busting (v=<timestamp>) in der Benachrichtigung.

rest_command:
  export_betriebskosten_pdf:
    url: >-
      {% set inv = ['unknown','unavailable','none','None',''] %}
      {% set y = (states('input_number.abrechnungsjahr') if states('input_number.abrechnungsjahr') not in inv else now().year) | int %}
      http://192.168.178.5:5000/export?whg=whg01&jahr={{ y }}&abrechnungsjahr={{ y }}
    method: POST
    content_type: "application/x-www-form-urlencoded"
    payload: >-
      {% set inv = ['unknown','unavailable','none','None',''] %}
      {% set y   = (states('input_number.abrechnungsjahr') if states('input_number.abrechnungsjahr') not in inv else now().year) | int %}
      {% set sel = states('input_select.haus_verteilerschluessel') %}
      {% set whg_f = states('input_number.whg01_wohnflaeche_m2') | replace(',', '.') | float(0) %}
      {% set haus_f= states('input_number.haus_nutzflaeche_m2_gesamt') | replace(',', '.') | float(0) %}
      {% set whg_p = states('input_number.whg01_personen') | int(0) %}
      {% set haus_p= states('input_number.haus_bewohner_anzahl') | int(0) %}
      {% set share = (whg_p / haus_p) if sel == 'personen' and haus_p > 0 else ((whg_f / haus_f) if haus_f > 0 else 0) %}
      {% set k_m3  = states('sensor.whg01_wasser_kalt_m3_gesamt') | replace(',', '.') | float(0) %}
      {% set w_m3  = states('sensor.whg01_wasser_warm_m3_gesamt') | replace(',', '.') | float(0) %}
      {% set kwh   = states('sensor.whg01_strom_wp_kwh_gesamt') | replace(',', '.') | float(0) %}
      {% set p_w   = states('input_number.haus_kosten_wasser_arbeitspreis_eur_m3') | replace(',', '.') | float(0) %}
      {% set p_a   = states('input_number.haus_kosten_abwasser_arbeitspreis_eur_m3') | replace(',', '.') | float(0) %}
      {% set p_st  = states('input_number.haus_kosten_strom_arbeitspreis_eur_kwh') | replace(',', '.') | float(0) %}
      {% set gp_st = states('input_number.whg01_strom_grundpreis_anteil_eur') | replace(',', '.') | float(0) %}
      {% set gr    = states('input_number.grundsteuer_eur_jahr_' ~ y) | replace(',', '.') | float(0) %}
      {% set vs    = states('input_number.versicherung_eur_jahr_' ~ y) | replace(',', '.') | float(0) %}
      {% set mu    = states('input_number.muell_eur_jahr_' ~ y) | replace(',', '.') | float(0) %}
      {% set nw    = states('input_number.niederschlagswasser_eur_jahr_' ~ y) | replace(',', '.') | float(0) %}
      {% set hz_w  = states('input_number.haus_betriebskosten_wartung_heizung_eur') | replace(',', '.') | float(0) %}
      {% set abr_s = states('input_number.haus_betriebskosten_abrechnungsservice_eur') | replace(',', '.') | float(0) %}
      {% set strom_var_eur = (kwh * p_st) | round(2) %}
      {% set wasser_eur    = ((k_m3 + w_m3) * p_w) | round(2) %}
      {% set abwasser_eur  = ((k_m3 + w_m3) * p_a) | round(2) %}
      {% set grundst_eur   = (gr * share) | round(2) %}
      {% set versich_eur   = (vs * share) | round(2) %}
      {% set muell_eur     = (mu * share) | round(2) %}
      {% set niedersch_eur = (nw * share) | round(2) %}
      {% set wartung_eur   = (hz_w * share) | round(2) %}
      {% set abrech_eur    = (abr_s * share) | round(2) %}
      abrechnungsjahr={{ y }}&
      jahr={{ y }}&
      created_at={{ now().isoformat() }}&
      verteilerschluessel={{ sel | urlencode }}&
      share={{ ('%.6f' % share) | urlencode }}&
      wasser_kalt_m3_gesamt={{ k_m3 | round(3) }}&
      wasser_warm_m3_gesamt={{ w_m3 | round(3) }}&
      strom_kwh_gesamt={{ kwh | round(3) }}&
      kosten_wasser_eur_m3={{ p_w }}&
      kosten_abwasser_eur_m3={{ p_a }}&
      kosten_strom_eur_kwh={{ p_st }}&
      strom_grundpreis_whg_eur={{ gp_st }}&
      haus_grundsteuer_eur={{ gr }}&
      haus_versicherung_eur={{ vs }}&
      haus_muell_eur={{ mu }}&
      haus_niederschlagswasser_eur={{ nw }}&
      haus_wartung_heizung_eur={{ hz_w }}&
      haus_abrechnungsservice_eur={{ abr_s }}&
      whg01_strom_variabel_anteil_eur={{ strom_var_eur }}&
      whg01_strom_grundpreis_anteil_eur={{ gp_st | round(2) }}&
      whg01_wasser_anteil_eur={{ wasser_eur }}&
      whg01_abwasser_anteil_eur={{ abwasser_eur }}&
      whg01_grundsteuer_anteil_eur={{ grundst_eur }}&
      whg01_versicherung_anteil_eur={{ versich_eur }}&
      whg01_muell_anteil_eur={{ muell_eur }}&
      whg01_niederschlagswasser_anteil_eur={{ niedersch_eur }}&
      whg01_wartung_heizung_anteil_eur={{ wartung_eur }}&
      whg01_abrechnungsservice_anteil_eur={{ abrech_eur }}

script:
  export_betriebskosten_pdf_now:
    alias: "Export: Betriebskosten PDF jetzt"
    mode: single
    sequence:
      - variables:
          y: "{{ (states('input_number.abrechnungsjahr') | int(default=now().year)) }}"
          t: "{{ now().timestamp() | int }}"
      - service: rest_command.export_betriebskosten_pdf
      - service: persistent_notification.create
        data:
          title: "Betriebskosten-Export {{ y }}"
          message: >-
            Fertig. Öffnen:
            http://192.168.178.60:8123/local/exports/bk_{{ y }}_latest.pdf?v={{ t }}
          notification_id: "bk_pdf_export"

template:
  - button:
      - name: "Export Betriebskosten PDF"
        unique_id: export_betriebskosten_pdf_button
        icon: mdi:file-pdf-box
        press:
          - service: script.export_betriebskosten_pdf_now
rest_command:
   export_betriebskosten_pdf:
    method: GET
    Betriebskostenabrechnung 2025
Erstellt am 2025-10-04 20:43:34
(Test-PDF vom Export-Server – Verbindung ok.)