# /config/packages/40_kosten_2025_haus.yaml
# Betriebskosten 2025 – Hausstrom (Stunde/Tag/Monat/Jahr)
# - Quelle Energie: sensor.zaehler_haus_allgemein_haus_zahlerstand_kanal_1_gesamt_kwh (Gesamt-kWh)
# - Preis: input_number.haus_betriebskosten_hausstrom_durchschnittspreis_eur_kwh_2025
# - Grundgebühr (Jahr): input_number.haus_betriebskosten_strom_grundgebuehr_2025

input_number:
  # Jahres-GRUNDGEBÜHR Strom (Tibber + Messstellengebühr + Netzgrundentgelt)
  haus_betriebskosten_strom_grundgebuehr_2025:
    name: "Haus – Betriebskosten: Strom Grundgebühr 2025 [€/Jahr]"
    min: 0
    max: 100000
    step: 0.01
    mode: box
    unit_of_measurement: "€"

  # Jährlicher Hausstrom-Verbrauch (Fallback/Manuell; bleibt für Jahres-Gesamtberechnung verfügbar)
  haus_betriebskosten_hausstrom_zaehlerstand_kwh_2025:
    name: "Haus – Betriebskosten: Hausstrom Zählerstand 2025 [kWh]"
    min: 0
    max: 10000000
    step: 0.01
    mode: box
    unit_of_measurement: "kWh"

  # Durchschnittspreis Tibber 2025 (€/kWh)
  haus_betriebskosten_hausstrom_durchschnittspreis_eur_kwh_2025:
    name: "Haus – Betriebskosten: Hausstrom Durchschnittspreis Tibber 2025 [€/kWh]"
    min: 0
    max: 10
    step: 0.0001
    mode: box
    unit_of_measurement: "€/kWh"

utility_meter:
  # Energie je Periode aus deinem Gesamtzähler (kWh)
  haus_allgemein_energy_hour_kwh:
    source: sensor.zaehler_haus_allgemein_haus_zahlerstand_kanal_1_gesamt_kwh
    cycle: hourly
  haus_allgemein_energy_day_kwh:
    source: sensor.zaehler_haus_allgemein_haus_zahlerstand_kanal_1_gesamt_kwh
    cycle: daily
  haus_allgemein_energy_month_kwh:
    source: sensor.zaehler_haus_allgemein_haus_zahlerstand_kanal_1_gesamt_kwh
    cycle: monthly
  haus_allgemein_energy_year_kwh:
    source: sensor.zaehler_haus_allgemein_haus_zahlerstand_kanal_1_gesamt_kwh
    cycle: yearly

template:
  - sensor:
      # ===== Kosten je Stunde (€/h) = kWh_stunde × Preis =====
      - name: haus_allgemeinstrom_kosten_stunde_eur
        unit_of_measurement: "€"
        state: >-
          {% set kwh = states('sensor.haus_allgemein_energy_hour_kwh') | float(0) %}
          {% set preis = states('input_number.haus_betriebskosten_hausstrom_durchschnittspreis_eur_kwh_2025') | float(0) %}
          {{ (kwh * preis) | round(4) }}
        attributes:
          friendly_name: "Haus – Allgemeinstrom Kosten [€/h]"
          kwh_stunde: "{{ states('sensor.haus_allgemein_energy_hour_kwh') | float(0) }}"
          preis_eur_kwh: "{{ states('input_number.haus_betriebskosten_hausstrom_durchschnittspreis_eur_kwh_2025') | float(0) }}"

      # ===== Kosten je Tag (€/Tag) = kWh_tag × Preis =====
      - name: haus_allgemeinstrom_kosten_tag_eur
        unit_of_measurement: "€"
        state: >-
          {% set kwh = states('sensor.haus_allgemein_energy_day_kwh') | float(0) %}
          {% set preis = states('input_number.haus_betriebskosten_hausstrom_durchschnittspreis_eur_kwh_2025') | float(0) %}
          {{ (kwh * preis) | round(2) }}
        attributes:
          friendly_name: "Haus – Allgemeinstrom Kosten [€/Tag]"
          kwh_tag: "{{ states('sensor.haus_allgemein_energy_day_kwh') | float(0) }}"
          preis_eur_kwh: "{{ states('input_number.haus_betriebskosten_hausstrom_durchschnittspreis_eur_kwh_2025') | float(0) }}"

      # ===== Kosten je Monat (€/Monat) = kWh_monat × Preis =====
      - name: haus_allgemeinstrom_kosten_monat_eur
        unit_of_measurement: "€"
        state: >-
          {% set kwh = states('sensor.haus_allgemein_energy_month_kwh') | float(0) %}
          {% set preis = states('input_number.haus_betriebskosten_hausstrom_durchschnittspreis_eur_kwh_2025') | float(0) %}
          {{ (kwh * preis) | round(2) }}
        attributes:
          friendly_name: "Haus – Allgemeinstrom Kosten [€/Monat]"
          kwh_monat: "{{ states('sensor.haus_allgemein_energy_month_kwh') | float(0) }}"
          preis_eur_kwh: "{{ states('input_number.haus_betriebskosten_hausstrom_durchschnittspreis_eur_kwh_2025') | float(0) }}"

      # ===== Kosten je Jahr (€/Jahr) = kWh_jahr × Preis =====
      - name: haus_allgemeinstrom_kosten_jahr_eur
        unit_of_measurement: "€"
        state: >-
          {% set kwh = states('sensor.haus_allgemein_energy_year_kwh') | float(0) %}
          {% set preis = states('input_number.haus_betriebskosten_hausstrom_durchschnittspreis_eur_kwh_2025') | float(0) %}
          {{ (kwh * preis) | round(2) }}
        attributes:
          friendly_name: "Haus – Allgemeinstrom Kosten [€/Jahr]"
          kwh_jahr: "{{ states('sensor.haus_allgemein_energy_year_kwh') | float(0) }}"
          preis_eur_kwh: "{{ states('input_number.haus_betriebskosten_hausstrom_durchschnittspreis_eur_kwh_2025') | float(0) }}"

      # ===== Gesamtkosten (inkl. Grundgebühr) =====
      - name: haus_allgemeinstrom_gesamt_tag_eur
        unit_of_measurement: "€"
        state: >-
          {% set var = states('sensor.haus_allgemeinstrom_kosten_tag_eur') | float(0) %}
          {% set fix = states('input_number.haus_betriebskosten_strom_grundgebuehr_2025') | float(0) / 365 %}
          {{ (var + fix) | round(2) }}
        attributes:
          friendly_name: "Haus – Allgemeinstrom gesamt [€/Tag]"

      - name: haus_allgemeinstrom_gesamt_monat_eur
        unit_of_measurement: "€"
        state: >-
          {% set var = states('sensor.haus_allgemeinstrom_kosten_monat_eur') | float(0) %}
          {% set fix = states('input_number.haus_betriebskosten_strom_grundgebuehr_2025') | float(0) / 12 %}
          {{ (var + fix) | round(2) }}
        attributes:
          friendly_name: "Haus – Allgemeinstrom gesamt [€/Monat]"

      - name: haus_allgemeinstrom_gesamt_jahr_eur
        unit_of_measurement: "€"
        state: >-
          {% set var = states('sensor.haus_allgemeinstrom_kosten_jahr_eur') | float(0) %}
          {% set fix = states('input_number.haus_betriebskosten_strom_grundgebuehr_2025') | float(0) %}
          {{ (var + fix) | round(2) }}
        attributes:
          friendly_name: "Haus – Allgemeinstrom gesamt [€/Jahr]"

      # ===== (bestehende) Jahresberechnung via manuellem Zählerstand bleibt verfügbar =====
      - name: haus_allgemeinstrom_kosten_eur_2025
        unit_of_measurement: "€"
        state: >-
          {% set raw = states('sensor.hausstrom_kwh_2025') %}
          {% set v = (raw if raw not in ['unknown','unavailable','none',''] else states('input_number.haus_betriebskosten_hausstrom_zaehlerstand_kwh_2025')) | float(0) %}
          {% set p = states('input_number.haus_betriebskosten_hausstrom_durchschnittspreis_eur_kwh_2025') | float(0) %}
          {{ (v * p) | round(2) }}
        attributes:
          friendly_name: "Haus – Allgemeinstrom Kosten 2025 [€/Jahr]"
          quelle_verbrauch: >-
            {% set raw = states('sensor.hausstrom_kwh_2025') %}
            {{ 'sensor.hausstrom_kwh_2025' if raw not in ['unknown','unavailable','none',''] else 'input_number.haus_betriebskosten_hausstrom_zaehlerstand_kwh_2025' }}
          verbrauch_kwh: >-
            {% set raw = states('sensor.hausstrom_kwh_2025') %}
            {{ (raw if raw not in ['unknown','unavailable','none',''] else states('input_number.haus_betriebskosten_hausstrom_zaehlerstand_kwh_2025')) | float(0) }}
          preis_eur_kwh: "{{ states('input_number.haus_betriebskosten_hausstrom_durchschnittspreis_eur_kwh_2025') | float(0) }}"

      - name: haus_allgemeinstrom_gesamt_eur_2025
        unit_of_measurement: "€"
        state: >-
          {% set var = states('sensor.haus_allgemeinstrom_kosten_eur_2025') | float(0) %}
          {% set fix = states('input_number.haus_betriebskosten_strom_grundgebuehr_2025') | float(0) %}
          {{ (var + fix) | round(2) }}
        attributes:
          friendly_name: "Haus – Allgemeinstrom gesamt 2025 [€]"
