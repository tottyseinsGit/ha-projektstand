# /config/packages/31_zaehler_whg04.yaml
# Zähler & Eichfristen – WHG04 (mit ZWEI Stromzählern: Haushalt + EV)
# - jahresneutrale Entity-IDs
# - Wasser/WMZ ohne Keys
# - Strom (Haushalt) via ZGW16-IP/devices/1/… ; EV via ZGW16-IP/devices/2/…

# ───────────────────────────────────────────────────────────────────────────────
# Stammdaten
# ───────────────────────────────────────────────────────────────────────────────
input_text:
  # --- Wasser kalt 1 ---
  whg04_wasser_kalt1_meter_id:
    name: "WHG04 – Wasser kalt 1: Meter-ID"
    max: 32
  whg04_wasser_kalt1_hersteller:
    name: "WHG04 – Wasser kalt 1: Hersteller/Typ"
    max: 80
  whg04_wasser_kalt1_standort:
    name: "WHG04 – Wasser kalt 1: Standort"
    max: 80

  # --- Wasser kalt 2 ---
  whg04_wasser_kalt2_meter_id:
    name: "WHG04 – Wasser kalt 2: Meter-ID"
    max: 32
  whg04_wasser_kalt2_hersteller:
    name: "WHG04 – Wasser kalt 2: Hersteller/Typ"
    max: 80
  whg04_wasser_kalt2_standort:
    name: "WHG04 – Wasser kalt 2: Standort"
    max: 80

  # --- Wasser warm ---
  whg04_wasser_warm_meter_id:
    name: "WHG04 – Wasser warm: Meter-ID"
    max: 32
  whg04_wasser_warm_hersteller:
    name: "WHG04 – Wasser warm: Hersteller/Typ"
    max: 80
  whg04_wasser_warm_standort:
    name: "WHG04 – Wasser warm: Standort"
    max: 80

  # --- WMZ ---
  whg04_wmz_meter_id:
    name: "WHG04 – WMZ: Meter-ID"
    max: 32
  whg04_wmz_hersteller:
    name: "WHG04 – WMZ: Hersteller/Typ"
    max: 80
  whg04_wmz_standort:
    name: "WHG04 – WMZ: Standort"
    max: 80

  # --- Strom Haushalt (optional manuelle Felder) ---
  whg04_strom_meter_id:
    name: "WHG04 – Strom Haushalt: Zählernummer/ID"
    max: 32
  whg04_strom_meter_key:
    name: "WHG04 – Strom Haushalt: Schlüssel (optional)"
    max: 64
  whg04_strom_hersteller:
    name: "WHG04 – Strom Haushalt: Hersteller/Typ"
    max: 80
  whg04_strom_standort:
    name: "WHG04 – Strom Haushalt: Standort"
    max: 80

  # --- Strom EV (optional manuelle Felder) ---
  whg04_strom_ev_meter_id:
    name: "WHG04 – Strom EV: Zählernummer/ID"
    max: 32
  whg04_strom_ev_meter_key:
    name: "WHG04 – Strom EV: Schlüssel (optional)"
    max: 64
  whg04_strom_ev_hersteller:
    name: "WHG04 – Strom EV: Hersteller/Typ"
    max: 80
  whg04_strom_ev_standort:
    name: "WHG04 – Strom EV: Standort"
    max: 80

# ───────────────────────────────────────────────────────────────────────────────
# Eichfristen & Montagedaten
# ───────────────────────────────────────────────────────────────────────────────
input_number:
  whg04_kw1_eichfrist_jahre:
    name: "WHG04 – Wasser kalt 1: Eichfrist [Jahre]"
    min: 1
    max: 20
    step: 1
    mode: box
    initial: 6
  whg04_kw2_eichfrist_jahre:
    name: "WHG04 – Wasser kalt 2: Eichfrist [Jahre]"
    min: 1
    max: 20
    step: 1
    mode: box
    initial: 6
  whg04_ww_eichfrist_jahre:
    name: "WHG04 – Wasser warm: Eichfrist [Jahre]"
    min: 1
    max: 20
    step: 1
    mode: box
    initial: 6
  whg04_wmz_eichfrist_jahre:
    name: "WHG04 – WMZ: Eichfrist [Jahre]"
    min: 1
    max: 20
    step: 1
    mode: box
    initial: 6
  whg04_strom_eichfrist_jahre:
    name: "WHG04 – Strom Haushalt: Eichfrist [Jahre]"
    min: 1
    max: 20
    step: 1
    mode: box
    initial: 8
  whg04_strom_ev_eichfrist_jahre:
    name: "WHG04 – Strom EV: Eichfrist [Jahre]"
    min: 1
    max: 20
    step: 1
    mode: box
    initial: 8

  # Vor-Montage kWh und Preis €/kWh (WHG04)
  whg04_strom_vormontage_kwh:
    name: "WHG04 – Strom vor Montage [kWh]"
    min: 0
    max: 100000
    step: 0.01
    mode: box
  whg04_strom_preis_eur_kwh:
    name: "WHG04 – Strompreis [€/kWh]"
    min: 0
    max: 2
    step: 0.0001
    mode: box

input_datetime:
  whg04_wasser_kalt1_montage:
    has_date: true
  whg04_wasser_kalt2_montage:
    has_date: true
  whg04_wasser_warm_montage:
    has_date: true
  whg04_wmz_montage:
    has_date: true
  whg04_strom_montage:
    has_date: true
  whg04_strom_ev_montage:
    has_date: true

# ───────────────────────────────────────────────────────────────────────────────
# MQTT – Strom (Haushalt + EV) über ZGW16-IP
# ───────────────────────────────────────────────────────────────────────────────
mqtt:
  sensor:
    # ===== Strom HAUSHALT (devices/1) =====
    - name: "whg04_strom_kwh_total"
      unique_id: whg04_strom_kwh_total
      state_topic: "ZGW16-IP/devices/1/Total_imported_active_energy"
      value_template: "{{ value_json.value | float(0) }}"
      unit_of_measurement: "kWh"
      device_class: energy
      state_class: total_increasing
      icon: mdi:lightning-bolt

    - name: "whg04_strom_power_w"
      unique_id: whg04_strom_power_w
      state_topic: "ZGW16-IP/devices/1/Total_active_power"
      value_template: "{{ value_json.value | float(0) }}"
      unit_of_measurement: "W"
      device_class: power
      state_class: measurement
      icon: mdi:flash

    - name: "whg04_strom_l1_current_a"
      unique_id: whg04_strom_l1_current_a
      state_topic: "ZGW16-IP/devices/1/L1_Current"
      value_template: "{{ value_json.value | float(0) }}"
      unit_of_measurement: "A"
      device_class: current
      state_class: measurement
    - name: "whg04_strom_l2_current_a"
      unique_id: whg04_strom_l2_current_a
      state_topic: "ZGW16-IP/devices/1/L2_Current"
      value_template: "{{ value_json.value | float(0) }}"
      unit_of_measurement: "A"
      device_class: current
      state_class: measurement
    - name: "whg04_strom_l3_current_a"
      unique_id: whg04_strom_l3_current_a
      state_topic: "ZGW16-IP/devices/1/L3_Current"
      value_template: "{{ value_json.value | float(0) }}"
      unit_of_measurement: "A"
      device_class: current
      state_class: measurement

    - name: "whg04_strom_l1_voltage_v"
      unique_id: whg04_strom_l1_voltage_v
      state_topic: "ZGW16-IP/devices/1/Voltage_of_L1_to_N"
      value_template: "{{ value_json.value | float(0) }}"
      unit_of_measurement: "V"
      device_class: voltage
      state_class: measurement
    - name: "whg04_strom_l2_voltage_v"
      unique_id: whg04_strom_l2_voltage_v
      state_topic: "ZGW16-IP/devices/1/Voltage_of_L2_to_N"
      value_template: "{{ value_json.value | float(0) }}"
      unit_of_measurement: "V"
      device_class: voltage
      state_class: measurement
    - name: "whg04_strom_l3_voltage_v"
      unique_id: whg04_strom_l3_voltage_v
      state_topic: "ZGW16-IP/devices/1/Voltage_of_L3_to_N"
      value_template: "{{ value_json.value | float(0) }}"
      unit_of_measurement: "V"
      device_class: voltage
      state_class: measurement

    - name: "whg04_strom_meter_serial"
      unique_id: whg04_strom_meter_serial
      state_topic: "ZGW16-IP/devices/1/Serial_number"
      value_template: "{{ value_json.value | string }}"
      icon: mdi:numeric

    # ===== Strom EV (devices/2) =====
    - name: "whg04_strom_ev_kwh_total"
      unique_id: whg04_strom_ev_kwh_total
      state_topic: "ZGW16-IP/devices/2/Total_imported_active_energy"
      value_template: "{{ value_json.value | float(0) }}"
      unit_of_measurement: "kWh"
      device_class: energy
      state_class: total_increasing
      icon: mdi:lightning-bolt

    - name: "whg04_strom_ev_power_w"
      unique_id: whg04_strom_ev_power_w
      state_topic: "ZGW16-IP/devices/2/Total_active_power"
      value_template: "{{ value_json.value | float(0) }}"
      unit_of_measurement: "W"
      device_class: power
      state_class: measurement
      icon: mdi:flash

    - name: "whg04_strom_ev_l1_current_a"
      unique_id: whg04_strom_ev_l1_current_a
      state_topic: "ZGW16-IP/devices/2/L1_Current"
      value_template: "{{ value_json.value | float(0) }}"
      unit_of_measurement: "A"
      device_class: current
      state_class: measurement
    - name: "whg04_strom_ev_l2_current_a"
      unique_id: whg04_strom_ev_l2_current_a
      state_topic: "ZGW16-IP/devices/2/L2_Current"
      value_template: "{{ value_json.value | float(0) }}"
      unit_of_measurement: "A"
      device_class: current
      state_class: measurement
    - name: "whg04_strom_ev_l3_current_a"
      unique_id: whg04_strom_ev_l3_current_a
      state_topic: "ZGW16-IP/devices/2/L3_Current"
      value_template: "{{ value_json.value | float(0) }}"
      unit_of_measurement: "A"
      device_class: current
      state_class: measurement

    - name: "whg04_strom_ev_l1_voltage_v"
      unique_id: whg04_strom_ev_l1_voltage_v
      state_topic: "ZGW16-IP/devices/2/Voltage_of_L1_to_N"
      value_template: "{{ value_json.value | float(0) }}"
      unit_of_measurement: "V"
      device_class: voltage
      state_class: measurement
    - name: "whg04_strom_ev_l2_voltage_v"
      unique_id: whg04_strom_ev_l2_voltage_v
      state_topic: "ZGW16-IP/devices/2/Voltage_of_L2_to_N"
      value_template: "{{ value_json.value | float(0) }}"
      unit_of_measurement: "V"
      device_class: voltage
      state_class: measurement
    - name: "whg04_strom_ev_l3_voltage_v"
      unique_id: whg04_strom_ev_l3_voltage_v
      state_topic: "ZGW16-IP/devices/2/Voltage_of_L3_to_N"
      value_template: "{{ value_json.value | float(0) }}"
      unit_of_measurement: "V"
      device_class: voltage
      state_class: measurement

    - name: "whg04_strom_ev_meter_serial"
      unique_id: whg04_strom_ev_meter_serial
      state_topic: "ZGW16-IP/devices/2/Serial_number"
      value_template: "{{ value_json.value | string }}"
      icon: mdi:numeric

# ───────────────────────────────────────────────────────────────────────────────
# Utility-Meter – jahresneutral (Haushalt + EV getrennt)
# ───────────────────────────────────────────────────────────────────────────────
utility_meter:
  # Haushalt
  whg04_strom_kwh_day:
    name: "WHG04 – Strom Haushalt kWh heute"
    source: sensor.whg04_strom_kwh_total
    cycle: daily
  whg04_strom_kwh_month:
    name: "WHG04 – Strom Haushalt kWh Monat"
    source: sensor.whg04_strom_kwh_total
    cycle: monthly
  whg04_strom_kwh_year:
    name: "WHG04 – Strom Haushalt kWh Jahr"
    source: sensor.whg04_strom_kwh_total
    cycle: yearly

  # EV
  whg04_strom_ev_kwh_day:
    name: "WHG04 – Strom EV kWh heute"
    source: sensor.whg04_strom_ev_kwh_total
    cycle: daily
  whg04_strom_ev_kwh_month:
    name: "WHG04 – Strom EV kWh Monat"
    source: sensor.whg04_strom_ev_kwh_total
    cycle: monthly
  whg04_strom_ev_kwh_year:
    name: "WHG04 – Strom EV kWh Jahr"
    source: sensor.whg04_strom_ev_kwh_total
    cycle: yearly

# ───────────────────────────────────────────────────────────────────────────────
# Templated Sensoren – Ablaufdaten & Zähler-ID-Logik
# ───────────────────────────────────────────────────────────────────────────────
template:
  - sensor:
      # Ablauf: Wasser kalt 1
      - name: whg04_kw1_eich_ablauf
        unique_id: whg04_kw1_eich_ablauf
        device_class: timestamp
        state: >-
          {% set d = states('input_datetime.whg04_wasser_kalt1_montage') %}
          {% set y = states('input_number.whg04_kw1_eichfrist_jahre')|int(6) %}
          {% if d not in ['unknown','unavailable',''] and y > 0 %}
            {% set base = as_datetime(d) %}
            {{ as_local(base.replace(year=base.year + y)).isoformat() }}
          {% else %} {{ none }} {% endif %}

      # Ablauf: Wasser kalt 2
      - name: whg04_kw2_eich_ablauf
        unique_id: whg04_kw2_eich_ablauf
        device_class: timestamp
        state: >-
          {% set d = states('input_datetime.whg04_wasser_kalt2_montage') %}
          {% set y = states('input_number.whg04_kw2_eichfrist_jahre')|int(6) %}
          {% if d not in ['unknown','unavailable',''] and y > 0 %}
            {% set base = as_datetime(d) %}
            {{ as_local(base.replace(year=base.year + y)).isoformat() }}
          {% else %} {{ none }} {% endif %}

      # Aggregiert: frühestes Ablaufdatum kalt1/kalt2
      - name: whg04_kw_eich_ablauf
        unique_id: whg04_kw_eich_ablauf
        device_class: timestamp
        state: >-
          {% set s1 = states('sensor.whg04_kw1_eich_ablauf') %}
          {% set s2 = states('sensor.whg04_kw2_eich_ablauf') %}
          {% set v1 = s1 not in ['unknown','unavailable',''] %}
          {% set v2 = s2 not in ['unknown','unavailable',''] %}
          {% if v1 and v2 %} {{ [as_datetime(s1), as_datetime(s2)] | min | as_local | isoformat }}
          {% elif v1 %} {{ s1 }}
          {% elif v2 %} {{ s2 }}
          {% else %} {{ none }} {% endif %}

      # Ablauf: Wasser warm
      - name: whg04_ww_eich_ablauf
        unique_id: whg04_ww_eich_ablauf
        device_class: timestamp
        state: >-
          {% set d = states('input_datetime.whg04_wasser_warm_montage') %}
          {% set y = states('input_number.whg04_ww_eichfrist_jahre')|int(6) %}
          {% if d not in ['unknown','unavailable',''] and y > 0 %}
            {% set base = as_datetime(d) %}
            {{ as_local(base.replace(year=base.year + y)).isoformat() }}
          {% else %} {{ none }} {% endif %}

      # Ablauf: WMZ
      - name: whg04_wmz_eich_ablauf
        unique_id: whg04_wmz_eich_ablauf
        device_class: timestamp
        state: >-
          {% set d = states('input_datetime.whg04_wmz_montage') %}
          {% set y = states('input_number.whg04_wmz_eichfrist_jahre')|int(6) %}
          {% if d not in ['unknown','unavailable',''] and y > 0 %}
            {% set base = as_datetime(d) %}
            {{ as_local(base.replace(year=base.year + y)).isoformat() }}
          {% else %} {{ none }} {% endif %}

      # Ablauf: Strom Haushalt
      - name: whg04_strom_eich_ablauf
        unique_id: whg04_strom_eich_ablauf
        device_class: timestamp
        state: >-
          {% set d = states('input_datetime.whg04_strom_montage') %}
          {% set y = states('input_number.whg04_strom_eichfrist_jahre')|int(8) %}
          {% if d not in ['unknown','unavailable',''] and y > 0 %}
            {% set base = as_datetime(d) %}
            {{ as_local(base.replace(year=base.year + y)).isoformat() }}
          {% else %} {{ none }} {% endif %}

      # Ablauf: Strom EV
      - name: whg04_strom_ev_eich_ablauf
        unique_id: whg04_strom_ev_eich_ablauf
        device_class: timestamp
        state: >-
          {% set d = states('input_datetime.whg04_strom_ev_montage') %}
          {% set y = states('input_number.whg04_strom_ev_eichfrist_jahre')|int(8) %}
          {% if d not in ['unknown','unavailable',''] and y > 0 %}
            {% set base = as_datetime(d) %}
            {{ as_local(base.replace(year=base.year + y)).isoformat() }}
          {% else %} {{ none }} {% endif %}

      # Effektive Zähler-ID – Haushalt (MQTT bevorzugt)
      - name: "WHG04 – Strom Haushalt: Zähler-ID (effektiv)"
        unique_id: whg04_strom_meter_id_effektiv
        state: >-
          {% set mqtt = states('sensor.whg04_strom_meter_serial') %}
          {% set man = states('input_text.whg04_strom_meter_id') %}
          {% set mqtt_ok = mqtt not in ['unknown','unavailable','','none'] %}
          {% set man_ok  = man  not in ['unknown','unavailable','','none'] %}
          {% if mqtt_ok %} {{ mqtt | string }}
          {% elif man_ok %} {{ man }}
          {% else %} {{ none }} {% endif %}
        attributes:
          quelle: >-
            {% set mqtt = states('sensor.whg04_strom_meter_serial') %}
            {{ 'mqtt' if mqtt not in ['unknown','unavailable','','none'] else 'manuell' }}
          mqtt_roh: "{{ states('sensor.whg04_strom_meter_serial') }}"
          manuell: "{{ states('input_text.whg04_strom_meter_id') }}"

      # Effektive Zähler-ID – EV (MQTT bevorzugt)
      - name: "WHG04 – Strom EV: Zähler-ID (effektiv)"
        unique_id: whg04_strom_ev_meter_id_effektiv
        state: >-
          {% set mqtt = states('sensor.whg04_strom_ev_meter_serial') %}
          {% set man = states('input_text.whg04_strom_ev_meter_id') %}
          {% set mqtt_ok = mqtt not in ['unknown','unavailable','','none'] %}
          {% set man_ok  = man  not in ['unknown','unavailable','','none'] %}
          {% if mqtt_ok %} {{ mqtt | string }}
          {% elif man_ok %} {{ man }}
          {% else %} {{ none }} {% endif %}
        attributes:
          quelle: >-
            {% set mqtt = states('sensor.whg04_strom_ev_meter_serial') %}
            {{ 'mqtt' if mqtt not in ['unknown','unavailable','','none'] else 'manuell' }}
          mqtt_roh: "{{ states('sensor.whg04_strom_ev_meter_serial') }}"
          manuell: "{{ states('input_text.whg04_strom_ev_meter_id') }}"

      # WHG04 Stromkosten – A3 + laufend + Gesamt
      - name: "WHG04 – Strom vor Montage €"
        unique_id: whg04_strom_vormontage_kosten_eur
        device_class: monetary
        unit_of_measurement: EUR
        icon: mdi:cash
        state: >-
          {{
            ( states('input_number.whg04_strom_vormontage_kwh')|float(0)
              * states('input_number.whg04_strom_preis_eur_kwh')|float(0)
            ) | round(2)
          }}

      - name: "WHG04 – Strom ab Montage (Jahr) €"
        unique_id: whg04_strom_kosten_ab_montage_eur
        device_class: monetary
        unit_of_measurement: EUR
        icon: mdi:cash-multiple
        state: >-
          {{
            ( states('sensor.whg04_strom_kwh_year')|float(0)
              * states('sensor.strom_preis_eur_kwh_eff')|float(0)
            ) | round(2)
          }}

      - name: "WHG04 – Strom Jahr gesamt (A3 + ab Montage) €"
        unique_id: whg04_strom_kosten_jahr_gesamt_eur
        device_class: monetary
        unit_of_measurement: EUR
        icon: mdi:calculator-variant
        state: >-
          {{
            (
              states('sensor.whg04_strom_vormontage_kosten_eur')|float(0) +
              states('sensor.whg04_strom_kosten_ab_montage_eur')|float(0)
            ) | round(2)
          }}

  - binary_sensor:
      # Konfliktprüfung – Haushalt
      - name: "WHG04 – Strom Haushalt: Zähler-ID Konflikt"
        unique_id: whg04_strom_meter_id_konflikt
        device_class: problem
        state: >-
          {% set mqtt = states('sensor.whg04_strom_meter_serial') %}
          {% set man  = states('input_text.whg04_strom_meter_id') %}
          {% set mqtt_ok = mqtt not in ['unknown','unavailable','','none'] %}
          {% set man_ok  = man  not in ['unknown','unavailable','','none'] %}
          {{ mqtt_ok and man_ok and (mqtt | string) != (man | string) }}
        attributes:
          mqtt: "{{ states('sensor.whg04_strom_meter_serial') }}"
          manuell: "{{ states('input_text.whg04_strom_meter_id') }}"

      # Konfliktprüfung – EV
      - name: "WHG04 – Strom EV: Zähler-ID Konflikt"
        unique_id: whg04_strom_ev_meter_id_konflikt
        device_class: problem
        state: >-
          {% set mqtt = states('sensor.whg04_strom_ev_meter_serial') %}
          {% set man  = states('input_text.whg04_strom_ev_meter_id') %}
          {% set mqtt_ok = mqtt not in ['unknown','unavailable','','none'] %}
          {% set man_ok  = man  not in ['unknown','unavailable','','none'] %}
          {{ mqtt_ok and man_ok and (mqtt | string) != (man | string) }}
        attributes:
          mqtt: "{{ states('sensor.whg04_strom_ev_meter_serial') }}"
          manuell: "{{ states('input_text.whg04_strom_ev_meter_id') }}"
